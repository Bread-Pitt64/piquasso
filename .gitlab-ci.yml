image: python:3.6

before_script:
  - pip install poetry

stages:
  - test
  - build

unittest:
  variables:
    GIT_SUBMODULE_STRATEGY: none
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"'
  stage: test
  script:
    - pip install tox
    - tox

benchmark:
  variables:
    GIT_SUBMODULE_STRATEGY: normal #to use submodule
  stage: test
  script:
    - apt update
    - apt-get install libeigen3-dev
    - poetry install
    - cd pennylane/benchmark/
    - poetry run python benchmark.py -d default.qubit time bm_entangling_layers > ./output.txt
  artifacts:
    paths:
      - pennylane/benchmark/output.txt
    expire_in: 15 days


buildpackage:
  stage: build
  variables:
    GIT_SUBMODULE_STRATEGY: none
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  script:
    - poetry config repositories.gitlab https://gitlab.inf.elte.hu/api/v4/projects/73/packages/pypi
    - poetry config pypi-token.gitlab 1z5AF-A6zsitDWpwGP91
    - poetry build
    - poetry publish -r gitlab

